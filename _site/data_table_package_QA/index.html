<!DOCTYPE html>
<html id="J-html" class="">
<head>
     <!--
     **
     * Author:         掌心
     * Contact:        zhanxin.info@gmail.com
     * Theme Name:     iLotus
     **
    -->
    <meta charset="UTF-8" />
    <title>
        
            data.table包问题整理
        
    </title>
    <meta name="generator" content="Jekyll" />
    <meta name="author" content="CCM" />
    <meta name="description" content="data.table包比tapply快10+倍，比==快100+倍, 比DF[i, j] <- value快500+倍，绝对是值得花精力去学习的一个包。" />
    <meta name="keywords" content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" media="all" href="http://iccm.cc/static/style.css" />
    <!--[if lt IE 9]>
    <script src="http://iccm.cc/static/js/html5.js" type="text/javascript"></script>
    <![endif]-->
    <script src="http://iccm.cc/static/js/jquery.js" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
                  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
                          });
    </script>
    <script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
</head>
<body itemscope itemtype="http://schema.org/WebPage" class="home blog lotus index">
    <nav class="lotus-nav">
        <ul>
            
            
            
            
            
            <li class="home ">
                <a href="/index.html" rel="bookmark" title="首页">
                    <i class="icon-home"></i>
                </a>
                
            </li>
            
            
            
            
            
            <li class="">
                <a href="/archives.html" rel="bookmark" title="文章归档">
                    <i class="icon-reorder"></i>
                </a>
                
            </li>
            
            
            
            
            
            <li class="">
                <a href="http://cn.linkedin.com/in/chaominchen" rel="bookmark" title="Linkedin">
                    <i class="icon-linkedin"></i>
                </a>
                
            </li>
            
            
            
            
            
            <li class="">
                <a href="https://github.com/ccmien" rel="bookmark" title="Github">
                    <i class="icon-github"></i>
                </a>
                
            </li>
            
        </ul>
    </nav>

    <p class="lotus-breadcrub">
    <a href="http://iccm.cc/index.html" rel="nofollow" rel="nofollow" title="首页">Home</a>
    <span> &gt; </span>
    <a href="http://iccm.cc/archives.html" rel="nofollow" >Archives</a>
    <span> &gt; </span>
    data.table包问题整理
</p>
<h1 class="lotus-pagetit">data.table包问题整理</h1>
<p class="lotus-meta">Publish: <time class="date" pubdate="July 12, 2014">July 12, 2014</time></p>
<article  itemscope itemtype="http://schema.org/Article" class="lotus-post lotus-post-columns-1">
<p>data.table包比tapply快10+倍，比==快100+倍, 比DF[i, j] &lt;- value快500+倍，绝对是值得花精力去学习的一个包。</p>

<p><img src="http://imgs.xkcd.com/comics/is_it_worth_the_time.png" alt="值得花多少时间" /></p>

<p>对于熟悉SQL的同学，data.table使用方法可以简单地概括为：</p>

<p><code class="highlighter-rouge">DT[where,select|update,group by][having][order by][ ]...[ ]</code></p>

<h2 id="q-">Q: 读入数据</h2>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">DT</span> <span class="o">&lt;-</span> <span class="n">fread</span><span class="p">(</span><span class="s2">"filelocation"</span><span class="p">)</span>
<span class="n">DT2</span> <span class="o">&lt;-</span> <span class="n">data.table</span><span class="p">(</span><span class="n">read.table</span><span class="p">(</span><span class="s2">"filelocation"</span><span class="p">))</span>
</code></pre>
</div>

<h2 id="q--1">Q: 新增/删除/更新变量</h2>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="c1"># add
</span><span class="n">DT</span><span class="p">[,</span> <span class="n">varnew</span> <span class="o">:=</span> <span class="n">var1</span> <span class="o">+</span> <span class="n">var2</span><span class="p">]</span>
<span class="n">DT</span><span class="p">[,</span> <span class="sb">`:=`</span><span class="p">(</span><span class="n">varnew1</span> <span class="o">=</span> <span class="n">var1</span> <span class="o">*</span> <span class="n">var2</span><span class="p">,</span> <span class="n">varnew2</span> <span class="o">=</span> <span class="n">var1</span> <span class="o">/</span> <span class="n">var2</span><span class="p">)]</span>
<span class="n">DT</span><span class="p">[,</span> <span class="n">c</span><span class="p">(</span><span class="s2">"varnew1"</span><span class="p">,</span> <span class="s2">"varnew2"</span><span class="p">)</span> <span class="o">:=</span> <span class="n">list</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;-</span> <span class="n">var1</span> <span class="o">*</span> <span class="n">var2</span><span class="p">,</span> <span class="n">tmp</span><span class="o">/</span><span class="m">100</span><span class="p">)]</span> <span class="c1"># 如果要接着用tmp, 此处只能用"&lt;-"
# delete
</span><span class="n">DT</span><span class="p">[,</span> <span class="n">var3</span> <span class="o">:=</span> <span class="n">NULL</span><span class="p">]</span>
<span class="n">DT</span><span class="p">[,</span> <span class="n">c</span><span class="p">(</span><span class="s2">"var4"</span><span class="p">,</span> <span class="s2">"var5"</span><span class="p">)</span> <span class="o">:=</span> <span class="n">NULL</span><span class="p">]</span>
<span class="c1"># update
</span><span class="n">DT</span><span class="p">[,</span> <span class="n">varupdate</span> <span class="o">:=</span> <span class="n">ifelse</span><span class="p">(</span><span class="n">var1</span> <span class="o">&gt;</span> <span class="n">var2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">varupdate</span><span class="p">)]</span>
<span class="n">DT</span><span class="p">[</span><span class="n">var1</span> <span class="o">&gt;</span> <span class="n">var2</span><span class="p">,</span> <span class="n">varupdate</span> <span class="o">:=</span> <span class="m">0</span><span class="p">]</span>
</code></pre>
</div>

<h2 id="qj">Q：j中函数使用变量名</h2>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">fun</span> <span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">where</span><span class="o">=</span><span class="n">parent.frame</span><span class="p">()){</span>
	<span class="k">return</span><span class="p">(</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">where</span><span class="p">)</span> <span class="o">*</span> <span class="n">get</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">where</span><span class="p">))</span>
	<span class="p">}</span>
<span class="n">DT</span><span class="p">[,</span> <span class="n">lapply</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s1">'var1'</span><span class="p">,</span><span class="s1">'var2'</span><span class="p">),</span> <span class="n">fun</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span><span class="s1">'var3'</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">.SD</span><span class="p">)]</span>
</code></pre>
</div>

<h2 id="q-result-for-group-n-has-column-n-type-typexeginteger-but-expecting-type-typeyegdouble">Q: 错误提示result for group n has column n type type_x(eg:’integer’) but expecting type type_y(eg:’double’)</h2>

<p>这是由于data.table包在计算完第一组变量后，会自动设定各变量的变量类型type_x。如果后面有一组的变量计算结果为type_y，就会导致此错误。比如计算变量mean(1:9), 结果是5，变量类型为integer，当后面某组计算mean(1:10)这样返回值5.5是double类型时，就会出现错误。</p>

<p>解决方法很简单，统一变量类型。比如用as.double(mean(vector))将返回值强制变量类型为double就可以了。</p>

</article>
<div class="comment">
    
        
        <div class="comment-cnt">
            <div class="ds-thread"></div>
        </div>
        
    
</div>
<p class="lotus-anno">声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/" rel="nofollow" target="_blank" title="自由转载-非商用-非衍生-保持署名">BY-NC-SA</a> 授权。转载请注明转自: <a href="" title="" rel="nofollow">CCM</a></p>
<section class="lotus-nextpage fn-clear">
    
    <div class="lotus-nextpage-left"><a class="prev" href="/monty-hall-problem" rel="prev">&laquo;&nbsp;三门问题及解法</a></div>
    
    
    <div class="lotus-nextpage-right"><a class="next" href="/sound-of-sorting/" rel="next">萌萌哒排序法声音&nbsp;&raquo;</a></div>
    
</section>


<footer class="lotus-footer">
	<p>Copyright © 2011–2016 i CCM All rights reserved. </a>.</p>
</footer>
<script src="http://iccm.cc/static/js/jquery.scrollTo.js" type="text/javascript"></script>
<script src="http://iccm.cc/static/js/iLotus.js" type="text/javascript"></script>
    
</body>
</html>
